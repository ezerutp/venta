<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
    th:replace="~{fragments/base :: layout('OLPESA - Punto de Venta', ~{::main})}">

<!-- Variables para el header -->
<th:block th:with="pageTitle='Ventas', pageSubtitle='Punto de venta y gestión'"></th:block>

<!-- Contenido específico de Ventas -->
<main>
    <div class="flex-1 overflow-auto p-8 m-4">
        <!-- Botones de acción -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex space-x-4">
                <button onclick="nuevaVenta(this)" 
                    th:data-usuario-id="${usuarioAutenticadoId}"
                    th:data-usuario-nombre="${usuarioAutenticadoNombre}"
                    class="bg-olpesa-green text-white px-4 py-2 rounded-lg hover:bg-olpesa-dark-green transition-colors">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Nueva Venta
                </button>
                <button onclick="actualizarEstadisticas()" class="bg-olpesa-orange text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Actualizar
                </button>
            </div>

            <div class="flex space-x-2">
                <input type="text" placeholder="Buscar ventas..." id="buscarVentas"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olpesa-green focus:border-transparent">
                <button onclick="buscarVentas()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tarjetas de estadísticas de ventas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Ventas</p>
                        <p class="text-2xl font-bold text-olpesa-gray" th:text="${totalVentas}">0</p>
                        <p class="text-xs text-green-600">Todas las ventas</p>
                    </div>
                    <div class="p-3 bg-olpesa-green/10 rounded-xl">
                        <svg class="w-8 h-8 text-olpesa-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Ventas Confirmadas</p>
                        <p class="text-2xl font-bold text-olpesa-gray" th:text="${ventasConfirmadas}">0</p>
                        <p class="text-xs text-green-600">Estado completado</p>
                    </div>
                    <div class="p-3 bg-olpesa-light-green/10 rounded-xl">
                        <svg class="w-8 h-8 text-olpesa-light-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Ventas Pendientes</p>
                        <p class="text-2xl font-bold text-olpesa-gray" th:text="${ventasPendientes}">0</p>
                        <p class="text-xs text-yellow-600">En proceso</p>
                    </div>
                    <div class="p-3 bg-olpesa-orange/10 rounded-xl">
                        <svg class="w-8 h-8 text-olpesa-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Ingresos</p>
                        <p class="text-2xl font-bold text-olpesa-gray">S/ <span th:text="${#numbers.formatDecimal(totalIngresos ?: 0, 1, 'COMMA', 2, 'POINT')}">0.00</span></p>
                        <p class="text-xs text-green-600">Ventas confirmadas</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-xl">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de ventas -->
        <div class="stat-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-olpesa-gray">Lista de Ventas</h3>
                <div class="flex space-x-2">
                    <select class="border border-gray-300 rounded-lg px-3 py-1 text-sm" onchange="filtrarPorEstado(this.value)">
                        <option value="">Todos los estados</option>
                        <option value="PENDIENTE">Pendientes</option>
                        <option value="CONFIRMADA">Confirmadas</option>
                        <option value="CANCELADA">Canceladas</option>
                    </select>
                    <select class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                        <option value="10">10 por página</option>
                        <option value="25">25 por página</option>
                        <option value="50">50 por página</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Cliente</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Producto</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Cantidad</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Total</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Estado</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Fecha</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-600">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="venta : ${ventas}" class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4">
                                <span class="font-medium text-olpesa-gray" th:text="${venta.id}">#001</span>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-olpesa-green text-white rounded-full flex items-center justify-center text-sm font-medium mr-3">
                                        <span th:text="${venta.cliente.nombreRazon.substring(0,1).toUpperCase()}">C</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900" th:text="${venta.cliente.nombreRazon}">Cliente</div>
                                        <div class="text-sm text-gray-500" th:text="${venta.cliente.numeroDocumento}">documento</div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3 px-4">
                                <div>
                                    <div class="font-medium text-gray-900" th:text="${venta.producto.nombre}">Producto</div>
                                    <div class="text-sm text-gray-500" th:text="${venta.producto.sku}">SKU</div>
                                </div>
                            </td>
                            <td class="py-3 px-4">
                                <span class="text-gray-900" th:text="${venta.cantidad}">1</span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="font-medium text-gray-900">S/ <span th:text="${#numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}">0.00</span></span>
                            </td>
                            <td class="py-3 px-4">
                                <span th:switch="${venta.estado}">
                                    <span th:case="'PENDIENTE'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800 border border-amber-200">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                        </svg>
                                        Pendiente
                                    </span>
                                    <span th:case="'CONFIRMADA'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Confirmada
                                    </span>
                                    <span th:case="'CANCELADA'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 border border-red-200">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                        </svg>
                                        Cancelada
                                    </span>
                                    <span th:case="*" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-200">
                                        <svg class="w-3 h-3 mr-1" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 6h2v5H9V6zm0 7h2v2H9v-2z"/>
                                        </svg>
                                        <span th:text="${venta.estado}">Desconocido</span>
                                    </span>
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <div class="text-sm text-gray-900" th:text="${#temporals.format(venta.fechaEmitido, 'dd/MM/yyyy')}">fecha</div>
                                <div class="text-sm text-gray-500" th:text="${#temporals.format(venta.fechaEmitido, 'HH:mm')}">hora</div>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex space-x-2">
                                    <button th:onclick="'verVenta(' + ${venta.id} + ')'" class="text-blue-600 hover:text-blue-900" title="Ver detalle">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                    
                                    <button th:if="${venta.estado.name() == 'PENDIENTE'}" th:onclick="'editarVenta(' + ${venta.id} + ')'" class="text-indigo-600 hover:text-indigo-900" title="Editar">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    
                                    <button th:if="${venta.estado.name() == 'PENDIENTE'}" th:onclick="'confirmarVenta(' + ${venta.id} + ')'" class="text-green-600 hover:text-green-900" title="Confirmar">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </button>
                                    
                                    <button th:if="${venta.estado.name() != 'CANCELADA'}" th:onclick="'cancelarVenta(' + ${venta.id} + ')'" class="text-red-600 hover:text-red-900" title="Cancelar">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(ventas)}">
                            <td colspan="8" class="py-8 px-4 text-center text-gray-500">
                                No hay ventas registradas
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <div class="flex items-center justify-between mt-6">
                <div class="text-sm text-gray-500">
                    Mostrando <span th:text="${(currentPage - 1) * pageSize + 1}">1</span> a
                    <span th:text="${currentPage * pageSize}">10</span> de
                    <span th:text="${totalElements}">0</span> resultados
                </div>
                <div class="flex space-x-2">
                    <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50"
                        th:disabled="${currentPage == 1}">Anterior</button>
                    <button th:each="page : ${#numbers.sequence(1, totalPages)}" th:text="${page}"
                        th:class="${page == currentPage} ? 'px-3 py-1 bg-olpesa-green text-white rounded' : 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-50'"
                        th:onclick="'goToPage(' + ${page} + ')'">1</button>
                    <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50"
                        th:disabled="${currentPage == totalPages}">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts específicos de ventas -->
    <script>
        // Variables globales para almacenar datos
        let clientes = [];
        let productos = [];

        // Cargar datos al iniciar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
        });

        function cargarDatos() {
            // Cargar clientes
            fetch('/api/ventas/clientes')
                .then(response => response.json())
                .then(data => {
                    clientes = data;
                })
                .catch(error => console.error('Error cargando clientes:', error));

            // Cargar productos
            fetch('/api/ventas/productos')
                .then(response => response.json())
                .then(data => {
                    productos = data.filter(p => p.estado && p.stockActual > 0);
                })
                .catch(error => console.error('Error cargando productos:', error));
        }

        function nuevaVenta(button) {
            // Obtener datos del usuario desde el botón
            const usuarioId = button.dataset.usuarioId;
            const usuarioNombre = button.dataset.usuarioNombre;
            
            console.log('Usuario desde botón - ID:', usuarioId, 'Nombre:', usuarioNombre);
            
            Swal.fire({
                title: 'Nueva Venta',
                html: `
                    <form id="nuevaVentaForm" class="text-left">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="mb-4">
                                <label for="clienteId" class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <select id="clienteId" name="clienteId" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                                    <option value="">Seleccionar cliente...</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Vendedor</label>
                                <div class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-700">
                                    <span id="nombreVendedor">Usuario Logueado</span>
                                    <input type="hidden" id="usuarioId" name="usuarioId" value="">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="productoId" class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                                <select id="productoId" name="productoId" required onchange="actualizarPrecioProducto()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                                    <option value="">Seleccionar producto...</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                                <input type="number" id="cantidad" name="cantidad" min="1" required onchange="calcularTotales()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                                <small id="stockDisponible" class="text-gray-500"></small>
                            </div>
                            <div class="mb-4">
                                <label for="tipoComprobante" class="block text-sm font-medium text-gray-700 mb-2">Tipo Comprobante</label>
                                <select id="tipoComprobante" name="tipoComprobante" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                                    <option value="BOLETA">Boleta</option>
                                    <option value="FACTURA">Factura</option>
                                    <option value="NOTA_CREDITO">Nota de Crédito</option>
                                    <option value="NOTA_DEBITO">Nota de Débito</option>
                                    <option value="TICKET">Ticket</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="metodoPago" class="block text-sm font-medium text-gray-700 mb-2">Método Pago</label>
                                <select id="metodoPago" name="metodoPago" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                                    <option value="EFECTIVO">Efectivo</option>
                                    <option value="TARJETA_CREDITO">Tarjeta de Crédito</option>
                                    <option value="TARJETA_DEBITO">Tarjeta de Débito</option>
                                    <option value="TRANSFERENCIA_BANCARIA">Transferencia</option>
                                    <option value="YAPE">Yape</option>
                                    <option value="PLIN">Plin</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Resumen de totales -->
                        <div class="bg-gray-50 p-4 rounded-lg mt-4">
                            <h4 class="font-medium mb-2">Resumen de Venta</h4>
                            <div class="flex justify-between">
                                <span>Precio Unitario:</span>
                                <span id="precioUnitario">S/ 0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span id="subtotal">S/ 0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>IGV (18%):</span>
                                <span id="igv">S/ 0.00</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold">
                                <span>Total:</span>
                                <span id="total">S/ 0.00</span>
                            </div>
                        </div>
                        
                        <div class="mb-4 mt-4">
                            <label for="montoPagado" class="block text-sm font-medium text-gray-700 mb-2">Monto Pagado</label>
                            <input type="number" id="montoPagado" name="montoPagado" step="0.01" min="0" required onchange="calcularCambio()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olpesa-green">
                            <div id="cambio" class="text-sm text-gray-600 mt-1"></div>
                        </div>
                    </form>
                `,
                width: '900px',
                showCancelButton: true,
                confirmButtonText: 'Crear Venta',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#d33',
                customClass: {
                    popup: 'rounded-xl',
                    confirmButton: 'rounded-lg px-6 py-2',
                    cancelButton: 'rounded-lg px-6 py-2',
                    htmlContainer: 'text-left'
                },
                didOpen: () => {
                    cargarSelectsNuevaVenta(usuarioId, usuarioNombre);
                },
                preConfirm: () => {
                    return validarFormularioVenta();
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    crearVenta(result.value);
                }
            });
        }

        function cargarSelectsNuevaVenta(usuarioId, usuarioNombre) {
            const clienteSelect = document.getElementById('clienteId');
            const productoSelect = document.getElementById('productoId');

            // Limpiar selects
            clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>';
            productoSelect.innerHTML = '<option value="">Seleccionar producto...</option>';

            // Establecer información del vendedor desde los parámetros
            document.getElementById('nombreVendedor').textContent = usuarioNombre;
            document.getElementById('usuarioId').value = usuarioId;

            // Cargar clientes
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nombreRazon} (${cliente.numeroDocumento})`;
                clienteSelect.appendChild(option);
            });

            // Cargar productos
            productos.forEach(producto => {
                const option = document.createElement('option');
                option.value = producto.id;
                option.textContent = `${producto.nombre} (Stock: ${producto.stockActual})`;
                option.dataset.precio = producto.precioUnitario;
                option.dataset.stock = producto.stockActual;
                productoSelect.appendChild(option);
            });
        }

        function actualizarPrecioProducto() {
            const productoSelect = document.getElementById('productoId');
            const cantidadInput = document.getElementById('cantidad');
            const stockSpan = document.getElementById('stockDisponible');
            const precioSpan = document.getElementById('precioUnitario');

            if (productoSelect.value) {
                const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                const precio = parseFloat(selectedOption.dataset.precio);
                const stock = parseInt(selectedOption.dataset.stock);

                precioSpan.textContent = `S/ ${precio.toFixed(2)}`;
                stockSpan.textContent = `Stock disponible: ${stock}`;
                cantidadInput.max = stock;
                
                calcularTotales();
            } else {
                precioSpan.textContent = 'S/ 0.00';
                stockSpan.textContent = '';
                cantidadInput.max = '';
            }
        }

        function calcularTotales() {
            const productoSelect = document.getElementById('productoId');
            const cantidadInput = document.getElementById('cantidad');
            const subtotalSpan = document.getElementById('subtotal');
            const igvSpan = document.getElementById('igv');
            const totalSpan = document.getElementById('total');

            if (productoSelect.value && cantidadInput.value) {
                const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                const precio = parseFloat(selectedOption.dataset.precio);
                const cantidad = parseInt(cantidadInput.value);

                const subtotal = precio * cantidad;
                const igv = subtotal * 0.18;
                const total = subtotal + igv;

                subtotalSpan.textContent = `S/ ${subtotal.toFixed(2)}`;
                igvSpan.textContent = `S/ ${igv.toFixed(2)}`;
                totalSpan.textContent = `S/ ${total.toFixed(2)}`;

                // Auto-llenar monto pagado con el total
                document.getElementById('montoPagado').value = total.toFixed(2);
                calcularCambio();
            } else {
                subtotalSpan.textContent = 'S/ 0.00';
                igvSpan.textContent = 'S/ 0.00';
                totalSpan.textContent = 'S/ 0.00';
                document.getElementById('montoPagado').value = '';
                document.getElementById('cambio').textContent = '';
            }
        }

        function calcularCambio() {
            const totalSpan = document.getElementById('total');
            const montoPagadoInput = document.getElementById('montoPagado');
            const cambioDiv = document.getElementById('cambio');

            if (totalSpan.textContent !== 'S/ 0.00' && montoPagadoInput.value) {
                const total = parseFloat(totalSpan.textContent.replace('S/ ', ''));
                const montoPagado = parseFloat(montoPagadoInput.value);
                const cambio = montoPagado - total;

                if (cambio >= 0) {
                    cambioDiv.textContent = `Cambio: S/ ${cambio.toFixed(2)}`;
                    cambioDiv.className = 'text-sm text-green-600 mt-1';
                } else {
                    cambioDiv.textContent = `Falta: S/ ${Math.abs(cambio).toFixed(2)}`;
                    cambioDiv.className = 'text-sm text-red-600 mt-1';
                }
            } else {
                cambioDiv.textContent = '';
            }
        }

        function validarFormularioVenta() {
            const form = document.getElementById('nuevaVentaForm');
            const formData = new FormData(form);
            
            // Validar campos requeridos
            const campos = ['clienteId', 'usuarioId', 'productoId', 'cantidad', 'tipoComprobante', 'metodoPago', 'montoPagado'];
            for (let campo of campos) {
                if (!formData.get(campo)) {
                    Swal.showValidationMessage(`Por favor complete el campo ${campo.replace('Id', '').replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return false;
                }
            }

            // Validar cantidad vs stock
            const productoSelect = document.getElementById('productoId');
            const cantidad = parseInt(formData.get('cantidad'));
            const selectedOption = productoSelect.options[productoSelect.selectedIndex];
            const stock = parseInt(selectedOption.dataset.stock);

            if (cantidad > stock) {
                Swal.showValidationMessage(`La cantidad no puede ser mayor al stock disponible (${stock})`);
                return false;
            }

            // Validar monto pagado
            const total = parseFloat(document.getElementById('total').textContent.replace('S/ ', ''));
            const montoPagado = parseFloat(formData.get('montoPagado'));

            if (montoPagado < total) {
                Swal.showValidationMessage('El monto pagado no puede ser menor al total');
                return false;
            }

            return {
                clienteId: formData.get('clienteId'),
                usuarioId: formData.get('usuarioId'),
                productoId: formData.get('productoId'),
                cantidad: formData.get('cantidad'),
                tipoComprobante: formData.get('tipoComprobante'),
                metodoPago: formData.get('metodoPago'),
                montoPagado: formData.get('montoPagado')
            };
        }

        function crearVenta(ventaData) {
            // Mostrar loading
            Swal.fire({
                title: 'Procesando...',
                text: 'Creando la venta',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/api/ventas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(ventaData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#4CAF50',
                        customClass: {
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#d33',
                        customClass: {
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error al crear la venta',
                    icon: 'error',
                    confirmButtonColor: '#d33',
                    customClass: {
                        confirmButton: 'rounded-lg px-6 py-2'
                    }
                });
            });
        }

        function verVenta(id) {
            // Mostrar loading
            Swal.fire({
                title: 'Cargando...',
                text: 'Obteniendo información de la venta',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/api/ventas/' + id)
                .then(response => response.json())
                .then(venta => {
                    Swal.fire({
                        title: `Detalle de Venta #${venta.id}`,
                        html: `
                            <div class="text-left">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-bold mb-2">Información General</h4>
                                        <p><strong>ID:</strong> ${venta.id}</p>
                                        <p><strong>Fecha:</strong> ${new Date(venta.fechaEmitido).toLocaleString()}</p>
                                        <p><strong>Estado:</strong> 
                                            ${venta.estado === 'PENDIENTE' ? 
                                                '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800 border border-amber-200 ml-2"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>Pendiente</span>' :
                                              venta.estado === 'CONFIRMADA' ? 
                                                '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800 border border-emerald-200 ml-2"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>Confirmada</span>' :
                                                '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 border border-red-200 ml-2"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>Cancelada</span>'
                                            }
                                        </p>
                                        <p><strong>Comprobante:</strong> ${venta.tipoComprobante}</p>
                                        <p><strong>Método Pago:</strong> ${venta.metodoPago}</p>
                                        <p><strong>Vendedor:</strong> ${venta.nombreVendedor}</p>
                                    </div>
                                    <div>
                                        <h4 class="font-bold mb-2">Cliente</h4>
                                        <p><strong>Nombre:</strong> ${venta.clienteNombreRazon}</p>
                                        <p><strong>Documento:</strong> ${venta.clienteNumeroDocumento}</p>
                                        <p><strong>Email:</strong> ${venta.clienteEmail || 'N/A'}</p>
                                        <p><strong>Teléfono:</strong> ${venta.clienteTelefono || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h4 class="font-bold mb-2">Producto</h4>
                                        <p><strong>Nombre:</strong> ${venta.productoNombre}</p>
                                        <p><strong>SKU:</strong> ${venta.productoSku}</p>
                                        <p><strong>Cantidad:</strong> ${venta.cantidad}</p>
                                        <p><strong>Precio Unit.:</strong> ${venta.moneda} ${venta.precioUnitario.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <h4 class="font-bold mb-2">Totales</h4>
                                        <p><strong>Subtotal:</strong> ${venta.moneda} ${venta.subtotal.toFixed(2)}</p>
                                        <p><strong>IGV:</strong> ${venta.moneda} ${venta.impuestoTotal.toFixed(2)}</p>
                                        <p><strong>Total:</strong> ${venta.moneda} ${venta.total.toFixed(2)}</p>
                                        <p><strong>Pagado:</strong> ${venta.moneda} ${venta.montoPagado.toFixed(2)}</p>
                                        <p><strong>Cambio:</strong> ${venta.moneda} ${venta.cambio.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                        `,
                        width: '800px',
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#4CAF50',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al obtener la información de la venta',
                        icon: 'error',
                        confirmButtonColor: '#d33',
                        customClass: {
                            confirmButton: 'rounded-lg px-6 py-2'
                        }
                    });
                });
        }

        function confirmarVenta(id) {
            Swal.fire({
                title: '¿Confirmar venta?',
                text: "Esta acción no se puede deshacer",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    popup: 'rounded-xl',
                    confirmButton: 'rounded-lg px-6 py-2',
                    cancelButton: 'rounded-lg px-6 py-2'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/ventas/${id}/confirmar`, {
                        method: 'PUT'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: '¡Confirmada!',
                                text: data.message,
                                icon: 'success',
                                confirmButtonColor: '#4CAF50',
                                customClass: {
                                    confirmButton: 'rounded-lg px-6 py-2'
                                }
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message,
                                icon: 'error',
                                confirmButtonColor: '#d33',
                                customClass: {
                                    confirmButton: 'rounded-lg px-6 py-2'
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Error al confirmar la venta',
                            icon: 'error',
                            confirmButtonColor: '#d33',
                            customClass: {
                                confirmButton: 'rounded-lg px-6 py-2'
                            }
                        });
                    });
                }
            });
        }

        function cancelarVenta(id) {
            Swal.fire({
                title: '¿Cancelar venta?',
                text: "El stock del producto será restaurado",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#4CAF50',
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No cancelar',
                customClass: {
                    popup: 'rounded-xl',
                    confirmButton: 'rounded-lg px-6 py-2',
                    cancelButton: 'rounded-lg px-6 py-2'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/ventas/${id}/cancelar`, {
                        method: 'PUT'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: '¡Cancelada!',
                                text: data.message,
                                icon: 'success',
                                confirmButtonColor: '#4CAF50',
                                customClass: {
                                    confirmButton: 'rounded-lg px-6 py-2'
                                }
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message,
                                icon: 'error',
                                confirmButtonColor: '#d33',
                                customClass: {
                                    confirmButton: 'rounded-lg px-6 py-2'
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Error al cancelar la venta',
                            icon: 'error',
                            confirmButtonColor: '#d33',
                            customClass: {
                                confirmButton: 'rounded-lg px-6 py-2'
                            }
                        });
                    });
                }
            });
        }

        function editarVenta(id) {
            // Similar a nuevaVenta() pero cargando datos existentes
            fetch('/api/ventas/' + id)
                .then(response => response.json())
                .then(venta => {
                    // Implementar modal de edición similar a nuevaVenta
                    // pero con los datos precargados
                    console.log('Editar venta:', venta);
                })
                .catch(error => console.error('Error:', error));
        }

        function actualizarEstadisticas() {
            fetch('/api/ventas/estadisticas')
                .then(response => response.json())
                .then(data => {
                    location.reload(); // Simple reload para actualizar estadísticas
                })
                .catch(error => console.error('Error:', error));
        }

        function filtrarPorEstado(estado) {
            // Implementar filtrado por estado
            const filas = document.querySelectorAll('tbody tr');
            filas.forEach(fila => {
                if (estado === '' || fila.querySelector('.rounded-full').textContent.trim().toUpperCase().includes(estado)) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        function buscarVentas() {
            const termino = document.getElementById('buscarVentas').value.toLowerCase();
            const filas = document.querySelectorAll('tbody tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                if (texto.includes(termino)) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        function goToPage(page) {
            window.location.href = '/ventas?page=' + page;
        }
    </script>
</main>

</html>